import{i as e,a as t,e as r,z as i,c as n,G as o,u as p}from"../min-dash/min-dash.ed2edcc5.js";function s(){}function a(e,t){this.model=e,this.properties=t}s.prototype.get=function(e){return this.$model.properties.get(this,e)},s.prototype.set=function(e,t){this.$model.properties.set(this,e,t)},a.prototype.createType=function(e){var r=this.model,n=this.properties,o=Object.create(s.prototype);t(e.properties,(function(e){e.isMany||void 0===e.default||(o[e.name]=e.default)})),n.defineModel(o,r),n.defineDescriptor(o,e);var p=e.ns.name;function a(e){n.define(this,"$type",{value:p,enumerable:!0}),n.define(this,"$attrs",{value:{}}),n.define(this,"$parent",{writable:!0}),t(e,i((function(e,t){this.set(t,e)}),this))}return a.prototype=o,a.hasType=o.$instanceOf=this.model.hasType,n.defineModel(a,r),n.defineDescriptor(a,e),a};var f={String:!0,Boolean:!0,Integer:!0,Real:!0,Element:!0},y={String:function(e){return e},Boolean:function(e){return"true"===e},Integer:function(e){return parseInt(e,10)},Real:function(e){return parseFloat(e)}};function c(e,t){var r=y[e];return r?r(t):t}function u(e){return!!f[e]}function d(e){return!!y[e]}function h(e,t){var r,i,n=e.split(/:/);if(1===n.length)r=e,i=t;else{if(2!==n.length)throw new Error("expected <prefix:localName> or <localName>, got "+e);r=n[1],i=n[0]}return{name:e=(i?i+":":"")+r,prefix:i,localName:r}}function l(e){this.ns=e,this.name=e.name,this.allTypes=[],this.allTypesByName={},this.properties=[],this.propertiesByName={}}function m(e,r){this.packageMap={},this.typeMap={},this.packages=[],this.properties=r,t(e,i(this.registerPackage,this))}function g(e,t,r){var i=t[r];if(i in e)throw new Error("package with "+r+" <"+i+"> already defined")}function v(e){this.model=e}function w(e,t,r){Object.defineProperty(e,t.name,{enumerable:!t.isReference,writable:!0,value:r,configurable:!0})}function P(e){return e.replace(/^:/,"")}function N(e,t={}){this.properties=new v(this),this.factory=new a(this,this.properties),this.registry=new m(e,this.properties),this.typeCache={},this.config=t}l.prototype.build=function(){return p(this,["ns","name","allTypes","allTypesByName","properties","propertiesByName","bodyProperty","idProperty"])},l.prototype.addProperty=function(e,t,r){"boolean"==typeof t&&(r=t,t=void 0),this.addNamedProperty(e,!1!==r);var i=this.properties;void 0!==t?i.splice(t,0,e):i.push(e)},l.prototype.replaceProperty=function(e,t,r){var i=e.ns,n=this.properties,o=this.propertiesByName,p=e.name!==t.name;if(e.isId){if(!t.isId)throw new Error("property <"+t.ns.name+"> must be id property to refine <"+e.ns.name+">");this.setIdProperty(t,!1)}if(e.isBody){if(!t.isBody)throw new Error("property <"+t.ns.name+"> must be body property to refine <"+e.ns.name+">");this.setBodyProperty(t,!1)}var s=n.indexOf(e);if(-1===s)throw new Error("property <"+i.name+"> not found in property list");n.splice(s,1),this.addProperty(t,r?void 0:s,p),o[i.name]=o[i.localName]=t},l.prototype.redefineProperty=function(e,t,r){var i=e.ns.prefix,n=t.split("#"),o=h(n[0],i),p=h(n[1],o.prefix).name,s=this.propertiesByName[p];if(!s)throw new Error("refined property <"+p+"> not found");this.replaceProperty(s,e,r),delete e.redefines},l.prototype.addNamedProperty=function(e,t){var r=e.ns,i=this.propertiesByName;t&&(this.assertNotDefined(e,r.name),this.assertNotDefined(e,r.localName)),i[r.name]=i[r.localName]=e},l.prototype.removeNamedProperty=function(e){var t=e.ns,r=this.propertiesByName;delete r[t.name],delete r[t.localName]},l.prototype.setBodyProperty=function(e,t){if(t&&this.bodyProperty)throw new Error("body property defined multiple times (<"+this.bodyProperty.ns.name+">, <"+e.ns.name+">)");this.bodyProperty=e},l.prototype.setIdProperty=function(e,t){if(t&&this.idProperty)throw new Error("id property defined multiple times (<"+this.idProperty.ns.name+">, <"+e.ns.name+">)");this.idProperty=e},l.prototype.assertNotTrait=function(e){if((e.extends||[]).length)throw new Error(`cannot create <${e.name}> extending <${e.extends}>`)},l.prototype.assertNotDefined=function(e,t){var r=e.name,i=this.propertiesByName[r];if(i)throw new Error("property <"+r+"> already defined; override of <"+i.definedBy.ns.name+"#"+i.ns.name+"> by <"+e.definedBy.ns.name+"#"+e.ns.name+"> not allowed without redefines")},l.prototype.hasProperty=function(e){return this.propertiesByName[e]},l.prototype.addTrait=function(e,r){r&&this.assertNotTrait(e);var o=this.allTypesByName,p=this.allTypes,s=e.name;s in o||(t(e.properties,i((function(t){t=n({},t,{name:t.ns.localName,inherited:r}),Object.defineProperty(t,"definedBy",{value:e});var i=t.replaces,o=t.redefines;i||o?this.redefineProperty(t,i||o,i):(t.isBody&&this.setBodyProperty(t),t.isId&&this.setIdProperty(t),this.addProperty(t))}),this)),p.push(e),o[s]=e)},m.prototype.getPackage=function(e){return this.packageMap[e]},m.prototype.getPackages=function(){return this.packages},m.prototype.registerPackage=function(e){e=n({},e);var r=this.packageMap;g(r,e,"prefix"),g(r,e,"uri"),t(e.types,i((function(t){this.registerType(t,e)}),this)),r[e.uri]=r[e.prefix]=e,this.packages.push(e)},m.prototype.registerType=function(e,r){var o=h((e=n({},e,{superClass:(e.superClass||[]).slice(),extends:(e.extends||[]).slice(),properties:(e.properties||[]).slice(),meta:n(e.meta||{})})).name,r.prefix),p=o.name,s={};t(e.properties,i((function(e){var t=h(e.name,o.prefix),r=t.name;u(e.type)||(e.type=h(e.type,t.prefix).name),n(e,{ns:t,name:r}),s[r]=e}),this)),n(e,{ns:o,name:p,propertiesByName:s}),t(e.extends,i((function(e){var t=h(e,o.prefix),r=this.typeMap[t.name];r.traits=r.traits||[],r.traits.push(p)}),this)),this.definePackage(e,r),this.typeMap[p]=e},m.prototype.mapTypes=function(e,r,i){var n=u(e.name)?{name:e.name}:this.typeMap[e.name],o=this;function p(t,i){var n=h(t,u(t)?"":e.prefix);o.mapTypes(n,r,i)}function s(e){return p(e,!0)}if(!n)throw new Error("unknown type <"+e.name+">");t(n.superClass,i?s:function(e){return p(e,!1)}),r(n,!i),t(n.traits,s)},m.prototype.getEffectiveDescriptor=function(e){var t=h(e),r=new l(t);this.mapTypes(t,(function(e,t){r.addTrait(e,t)}));var i=r.build();return this.definePackage(i,i.allTypes[i.allTypes.length-1].$pkg),i},m.prototype.definePackage=function(e,t){this.properties.define(e,"$pkg",{value:t})},v.prototype.set=function(t,r,i){if(!e(r)||!r.length)throw new TypeError("property name must be a non-empty string");var n=this.getProperty(t,r),o=n&&n.name;void 0===i?n?delete t[o]:delete t.$attrs[P(r)]:n?o in t?t[o]=i:w(t,n,i):t.$attrs[P(r)]=i},v.prototype.get=function(e,t){var r=this.getProperty(e,t);if(!r)return e.$attrs[P(t)];var i=r.name;return!e[i]&&r.isMany&&w(e,r,[]),e[i]},v.prototype.define=function(e,t,r){if(!r.writable){var i=r.value;delete(r=n({},r,{get:function(){return i}})).value}Object.defineProperty(e,t,r)},v.prototype.defineDescriptor=function(e,t){this.define(e,"$descriptor",{value:t})},v.prototype.defineModel=function(e,t){this.define(e,"$model",{value:t})},v.prototype.getProperty=function(e,t){var r=this.model,i=r.getPropertyDescriptor(e,t);if(i)return i;if(t.includes(":"))return null;const n=r.config.strict;if(void 0!==n){const r=new TypeError(`unknown property <${t}> on <${e.$type}>`);if(n)throw r}return null},N.prototype.create=function(e,t){var r=this.getType(e);if(!r)throw new Error("unknown type <"+e+">");return new r(t)},N.prototype.getType=function(t){var r=this.typeCache,i=e(t)?t:t.ns.name,n=r[i];return n||(t=this.registry.getEffectiveDescriptor(i),n=r[i]=this.factory.createType(t)),n},N.prototype.createAny=function(e,i,n){var p=h(e),s={$type:e,$instanceOf:function(e){return e===this.$type},get:function(e){return this[e]},set:function(e,t){o(this,[e],t)}},a={name:e,isGeneric:!0,ns:{prefix:p.prefix,localName:p.localName,uri:i}};return this.properties.defineDescriptor(s,a),this.properties.defineModel(s,this),this.properties.define(s,"get",{enumerable:!1,writable:!0}),this.properties.define(s,"set",{enumerable:!1,writable:!0}),this.properties.define(s,"$parent",{enumerable:!1,writable:!0}),this.properties.define(s,"$instanceOf",{enumerable:!1,writable:!0}),t(n,(function(e,t){r(e)&&void 0!==e.value?s[e.name]=e.value:s[t]=e})),s},N.prototype.getPackage=function(e){return this.registry.getPackage(e)},N.prototype.getPackages=function(){return this.registry.getPackages()},N.prototype.getElementDescriptor=function(e){return e.$descriptor},N.prototype.hasType=function(e,t){return void 0===t&&(t=e,e=this),t in e.$model.getElementDescriptor(e).allTypesByName},N.prototype.getPropertyDescriptor=function(e,t){return this.getElementDescriptor(e).propertiesByName[t]},N.prototype.getTypeDescriptor=function(e){return this.registry.typeMap[e]};export{N as M,c,d as i,h as p};
