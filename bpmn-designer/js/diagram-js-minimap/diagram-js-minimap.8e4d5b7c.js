import{c as t,e,h as i,q as n}from"../min-dom/min-dom.04e3f566.js";import{c as a,a as o,b as s,d as r,r as h,h as l,g as d}from"../tiny-svg/tiny-svg.9f6d78cc.js";import{c as p,t as g,e as c,d as _}from"../min-dash/min-dash.f4c0fcf2.js";import{H as v}from"../hammerjs/hammerjs.8282e9c9.js";import{aw as u,aP as m}from"../diagram-js/diagram-js.31456ee9.js";var f={min:.2,max:4};function w(t,i,n,a,o){var s=this;this._canvas=a,this._elementRegistry=o,this._eventBus=n,this._injector=i,this._state={isOpen:void 0,isDragging:!1,initialDragPosition:null,offsetViewport:null,cachedViewbox:null,dragger:null,svgClientRect:null,parentClientRect:null,zoomDelta:0},this._init();var r=new v.Manager(document);r.add(new v.Pan),r.on("panmove",c),r.on("panend",_);var h=new v.Manager(this._svg);h.add(new v.Pan),h.on("panstart",g(!0)),h.add(new v.Tap),h.on("tap",(function(t){d(j(t))}));var l=new v.Manager(this._viewportDom);function d(t){s._state._svgClientRect&&!b(s._state._svgClientRect)||(s._state._svgClientRect=s._svg.getBoundingClientRect()),x(y({x:t.x-s._state._svgClientRect.left,y:t.y-s._state._svgClientRect.top},s._svg,s._lastViewbox),s._canvas),s._update()}function g(t){return function(i){var n=j(i);s._state._svgClientRect&&!b(s._state._svgClientRect)||(s._state._svgClientRect=s._svg.getBoundingClientRect()),t&&d(n);var o=y({x:n.x-s._state._svgClientRect.left,y:n.y-s._state._svgClientRect.top},s._svg,s._lastViewbox),r=a.viewbox(),h=function(t,e){var i={x:e.x+e.width/2,y:e.y+e.height/2};return{x:t.x-i.x,y:t.y-i.y}}(o,r),l=s._viewportDom.getBoundingClientRect(),g={x:n.x-l.left+1,y:n.y-l.top+1};p(s._state,{cachedViewbox:r,initialDragPosition:{x:n.x,y:n.y},isDragging:!0,offsetViewport:h,offsetViewportDom:g,viewportClientRect:s._viewport.getBoundingClientRect(),parentClientRect:s._parent.getBoundingClientRect()}),e.bind(document,"mousemove",c),e.bind(document,"mouseup",_)}}function c(t){var e=j(t);if(s._state.isDragging){s._state._svgClientRect&&!b(s._state._svgClientRect)||(s._state._svgClientRect=s._svg.getBoundingClientRect());var i=s._state.offsetViewportDom,n=s._state.viewportClientRect,a=s._state.parentClientRect;p(s._viewportDom.style,{top:e.y-i.y-a.top+"px",left:e.x-i.x-a.left+"px"});var o=E(a,{top:e.y-i.y-a.top,left:e.x-i.x-a.left,width:n.width,height:n.height});p(s._overlay.style,{clipPath:o});var r=y({x:e.x-s._state._svgClientRect.left,y:e.y-s._state._svgClientRect.top},s._svg,s._lastViewbox);x({x:r.x-s._state.offsetViewport.x,y:r.y-s._state.offsetViewport.y},s._canvas)}}function _(t){var i=j(t);s._state.isDragging&&(s._state.initialDragPosition.x===i.x&&s._state.initialDragPosition.y===i.y&&d(t),s._update(),p(s._state,{cachedViewbox:null,initialDragPosition:null,isDragging:!1,offsetViewport:null,offsetViewportDom:null}),e.unbind(document,"mousemove",c),e.unbind(document,"mouseup",_))}l.add(new v.Pan),l.on("panstart",g(!1)),this.toggle(t&&t.open||!1),e.bind(this._viewportDom,"mousedown",g(!1)),e.bind(this._svg,"mousedown",g(!0)),e.bind(this._parent,"wheel",(function(t){if(t.preventDefault(),t.stopPropagation(),t.ctrlKey&&(s._state._svgClientRect&&!b(s._state._svgClientRect)||(s._state._svgClientRect=s._svg.getBoundingClientRect()),e=t,i=s._state._svgClientRect,e.x>i.left&&e.x<i.left+i.width&&e.y>i.top&&e.y<i.top+i.height)){var e,i,n,o,r,h,l=0===t.deltaMode?.02:.32,d=Math.sqrt(Math.pow(t.deltaY,2)+Math.pow(t.deltaX,2))*D(t.deltaY)*-l;if(s._state.zoomDelta+=d,Math.abs(s._state.zoomDelta)>.1){var p=d>0?1:-1,g=Math.log(a.zoom())/Math.log(10),c=(n=f,o=20,r=Math.log(n.min)/Math.log(10),h=Math.log(n.max)/Math.log(10),(Math.abs(r)+Math.abs(h))/o),_=Math.round(g/c)*c;_+=c*p;var v=Math.pow(10,_);a.zoom(function(t,e){return Math.max(t.min,Math.min(t.max,e))}(f,v),u),s._state.zoomDelta=0;var u=y({x:t.clientX-s._state._svgClientRect.left,y:t.clientY-s._state._svgClientRect.top},s._svg,s._lastViewbox);x(u,s._canvas),s._update()}}})),e.bind(this._toggle,"click",(function(t){t.preventDefault(),t.stopPropagation(),s.toggle()})),n.on(["shape.added","connection.added"],(function(t){var e=t.element;s._addElement(e),s._update()})),n.on(["shape.removed","connection.removed"],(function(t){var e=t.element;s._removeElement(e),s._update()})),n.on("elements.changed",250,(function(t){t.elements.forEach((function(t){s._updateElement(t)})),s._update()})),n.on("element.updateId",(function(t){var e=t.element,i=t.newId;s._updateElementId(e,i)})),n.on("canvas.viewbox.changed",(function(){s._state.isDragging||s._update()})),n.on("canvas.resized",(function(){document.body.contains(s._parent)&&(s._state.isDragging||s._update(),s._state._svgClientRect=s._svg.getBoundingClientRect())})),n.on(["root.set","plane.set"],(function(t){s._clear(),(t.element||t.plane.rootElement).children.forEach((function(t){s._addElement(t)})),s._update()}))}function y(t,e,i){var n=e.getBoundingClientRect(),a=function(t,e){var i=t.width/t.height,n=p({},{x:t.x,y:t.y,width:t.width,height:t.height});if(i>e){var a=n.width*(1/e),o=n.y-(a-n.height)/2;p(n,{y:o,height:a})}else if(i<e){var s=n.height*e,r=n.x-(s-n.width)/2;p(n,{x:r,width:s})}return n}(i,n.width/n.height);return{x:C(t.x,0,n.width,a.x,a.x+a.width),y:C(t.y,0,n.height,a.y,a.y+a.height)}}function x(t,e){var i=e.viewbox(),n=i.width,a=i.height;e.viewbox({x:t.x-n/2,y:t.y-a/2,width:n,height:a})}function C(t,e,i,n,a){return(t-e)*(a-n)/(i-e)+n}function R(t,e,i){var o=function(t){var e=n(".children",t);e||(e=a("g",{class:"children"}),s(t,e));return e}(e),r=[].slice.call(o.childNodes)[i];r?e.insertBefore(t,r.nextSibling):e.appendChild(t)}function b(t){return 0===t.width&&0===t.height}w.$inject=["config.minimap","injector","eventBus","canvas","elementRegistry"],w.prototype._init=function(){var i=this._canvas.getContainer(),n=this._parent=document.createElement("div");t(n).add("djs-minimap"),i.appendChild(n);var h=this._toggle=document.createElement("div");t(h).add("toggle"),n.appendChild(h);var l=this._map=document.createElement("div");t(l).add("map"),n.appendChild(l);var d=this._svg=a("svg");o(d,{width:"100%",height:"100%"}),s(l,d);var p=this._elementsGroup=a("g");s(d,p);var g=this._viewportGroup=a("g");s(d,g);var c=this._viewport=a("rect");r(c).add("viewport"),s(g,c),e.bind(n,"mousedown",(function(t){t.stopPropagation()}));var _=this._viewportDom=document.createElement("div");t(_).add("viewport-dom"),this._parent.appendChild(_);var v=this._overlay=document.createElement("div");t(v).add("overlay"),this._parent.appendChild(v)},w.prototype._update=function(){var t=this._canvas.viewbox(),e=t.inner,i=t.outer;if(P(t)){var n,a,s,r,h=i.width-e.width,l=i.height-e.height;e.width<i.width?(n=e.x-h/2,s=i.width,e.x+e.width<i.width&&(n=Math.min(0,e.x))):(n=e.x,s=e.width),e.height<i.height?(a=e.y-l/2,r=i.height,e.y+e.height<i.height&&(a=Math.min(0,e.y))):(a=e.y,r=e.height),n-=50,a-=50,s+=100,r+=100,this._lastViewbox={x:n,y:a,width:s,height:r},o(this._svg,{viewBox:n+", "+a+", "+s+", "+r}),o(this._viewport,{x:t.x,y:t.y,width:t.width,height:t.height});var d=this._state._parentClientRect=this._parent.getBoundingClientRect(),g=this._viewport.getBoundingClientRect(),c={top:g.top-d.top,left:g.left-d.left,width:g.width,height:g.height};p(this._viewportDom.style,{top:c.top+"px",left:c.left+"px",width:c.width+"px",height:c.height+"px"});var _=E(d,c);p(this._overlay.style,{clipPath:_})}},w.prototype.open=function(){p(this._state,{isOpen:!0}),t(this._parent).add("open");var e=this._injector.get("translate",!1)||function(t){return t};i(this._toggle,"title",e("Close minimap")),this._update(),this._eventBus.fire("minimap.toggle",{open:!0})},w.prototype.close=function(){p(this._state,{isOpen:!1}),t(this._parent).remove("open");var e=this._injector.get("translate",!1)||function(t){return t};i(this._toggle,"title",e("Open minimap")),this._eventBus.fire("minimap.toggle",{open:!1})},w.prototype.toggle=function(t){var e=this.isOpen();void 0===t&&(t=!e),t!=e&&(t?this.open():this.close())},w.prototype.isOpen=function(){return this._state.isOpen},w.prototype._updateElement=function(t){try{void 0!==t.parent&&null!==t.parent&&(this._removeElement(t),this._addElement(t))}catch(e){}},w.prototype._updateElementId=function(t,e){try{var i=n("#"+u(t.id),this._elementsGroup);i&&(i.id=e)}catch(a){}},w.prototype.isOnActivePlane=function(t){var e=this._canvas;return e.findRoot?e.findRoot(t)===e.getRootElement():!e.findPlane||e.findPlane(t)===e.getActivePlane()},w.prototype._addElement=function(t){var e=this;if(this._removeElement(t),this.isOnActivePlane(t)){var i,a,s,r=this._createElement(t),h=n("#"+u(t.parent.id),this._elementsGroup);if(r){var l=function(t,e){var i=n(".djs-children",e.parentNode);if(!i)return;var a=[].slice.call(i.childNodes),o=-1;return a.forEach((function(e,i){n(".djs-element",e)===t&&(o=i)})),o}(this._elementRegistry.getGraphics(t),this._elementRegistry.getGraphics(t.parent));return"undefined"!==l&&h?h.childNodes.length>l?R(r,h,l):R(r,h,h.childNodes.length-1):this._elementsGroup.appendChild(r),!function(t){return t.waypoints}(t)?(a=t.x,s=t.y,h&&(a-=(i=t.parent).x,s-=i.y),o(r,{transform:"translate("+a+" "+s+")"})):(a=0,s=0,void 0!==(i=t.parent).x&&void 0!==i.y&&(a=-i.x,s=-i.y),o(r,{transform:"translate("+a+" "+s+")"})),t.children&&t.children.length&&t.children.forEach((function(t){e._addElement(t)})),r}}},w.prototype._removeElement=function(t){var e=this._svg.getElementById(t.id);e&&h(e)},w.prototype._createElement=function(t){var e,i=this._elementRegistry.getGraphics(t);if(i&&(e=m(i))){var n=l(e);return o(n,{id:t.id}),n}},w.prototype._clear=function(){d(this._elementsGroup)};var D=Math.sign||function(t){return t>=0?1:-1};function E(t,e){return"polygon("+[M(e.left,e.top),M(e.left+e.width,e.top),M(e.left+e.width,e.top+e.height),M(e.left,e.top+e.height),M(e.left,t.height),M(t.width,t.height),M(t.width,0),M(0,0),M(0,t.height),M(e.left,t.height)].join(", ")+")"}function M(t,e){return t+"px "+e+"px"}function P(t){return g(t,(function(t){return c(t)?P(t):_(t)&&isFinite(t)}))}function j(t){return t.center?t.center:{x:t.clientX,y:t.clientY}}var B={__init__:["minimap"],minimap:["type",w]};export{B as i};
