import{aN as t}from"../diagram-js/diagram-js.de1051b7.js";import{y as e,q as i,c as n,b as o}from"../min-dash/min-dash.1b936205.js";import{a as s,q as r,e as a,r as h}from"../min-dom/min-dom.04e3f566.js";var d=Math.min,l=Math.max;function c(t){t.preventDefault()}function p(t){t.stopPropagation()}function u(t){this.container=t.container,this.parent=s('<div class="djs-direct-editing-parent"><div class="djs-direct-editing-content" contenteditable="true"></div></div>'),this.content=r("[contenteditable]",this.parent),this.keyHandler=t.keyHandler||function(){},this.resizeHandler=t.resizeHandler||function(){},this.autoResize=e(this.autoResize,this),this.handlePaste=e(this.handlePaste,this)}function f(t,i){this._eventBus=t,this._providers=[],this._textbox=new u({container:i.getContainer(),keyHandler:e(this._handleKey,this),resizeHandler:e(this._handleResize,this)})}u.prototype.create=function(t,e,o,s){var r=this.parent,h=this.content,d=this.container;s=this.options=s||{},e=this.style=e||{};var l=i(e,["width","height","maxWidth","maxHeight","minWidth","minHeight","left","top","backgroundColor","position","overflow","border","wordWrap","textAlign","outline","transform"]);n(r.style,{width:t.width+"px",height:t.height+"px",maxWidth:t.maxWidth+"px",maxHeight:t.maxHeight+"px",minWidth:t.minWidth+"px",minHeight:t.minHeight+"px",left:t.x+"px",top:t.y+"px",backgroundColor:"#ffffff",position:"absolute",overflow:"visible",border:"1px solid #ccc",boxSizing:"border-box",wordWrap:"normal",textAlign:"center",outline:"none"},l);var c=i(e,["fontFamily","fontSize","fontWeight","lineHeight","padding","paddingTop","paddingRight","paddingBottom","paddingLeft"]);return n(h.style,{boxSizing:"border-box",width:"100%",outline:"none",wordWrap:"break-word"},c),s.centerVertically&&n(h.style,{position:"absolute",top:"50%",transform:"translate(0, -50%)"},c),h.innerText=o,a.bind(h,"keydown",this.keyHandler),a.bind(h,"mousedown",p),a.bind(h,"paste",this.handlePaste),s.autoResize&&a.bind(h,"input",this.autoResize),s.resizable&&this.resizable(e),d.appendChild(r),this.setSelection(h.lastChild,h.lastChild&&h.lastChild.length),r},u.prototype.handlePaste=function(t){var e,i=this.options,n=this.style;if(t.preventDefault(),e=t.clipboardData?t.clipboardData.getData("text/plain"):window.clipboardData.getData("Text"),this.insertText(e),i.autoResize){var o=this.autoResize(n);o&&this.resizeHandler(o)}},u.prototype.insertText=function(t){t=t.replace(/\r\n|\r|\n/g,"\n"),document.execCommand("insertText",!1,t)||this._insertTextIE(t)},u.prototype._insertTextIE=function(t){var e,i,n,o=this.getSelection(),s=o.startContainer,r=o.endContainer,a=o.startOffset,d=o.endOffset,l=o.commonAncestorContainer,c=(e=l.childNodes,[].slice.call(e));if(l.nodeType===Node.TEXT_NODE){var p=s.textContent;s.textContent=p.substring(0,a)+t+p.substring(d),i=s,n=a+t.length}else if(s===this.content&&r===this.content){var u=document.createTextNode(t);this.content.insertBefore(u,c[a]),i=u,n=u.textContent.length}else{var f=c.indexOf(s),g=c.indexOf(r);c.forEach((function(e,i){i===f?e.textContent=s.textContent.substring(0,a)+t+r.textContent.substring(d):i>f&&i<=g&&h(e)})),i=s,n=a+t.length}i&&void 0!==n&&setTimeout((function(){self.setSelection(i,n)}))},u.prototype.autoResize=function(){var t=this.parent,e=this.content,i=parseInt(this.style.fontSize)||12;if(e.scrollHeight>t.offsetHeight||e.scrollHeight<t.offsetHeight-i){var n=t.getBoundingClientRect(),o=e.scrollHeight;t.style.height=o+"px",this.resizeHandler({width:n.width,height:n.height,dx:0,dy:o-n.height})}},u.prototype.resizable=function(){var t=this,e=this.parent,i=this.resizeHandle,o=parseInt(this.style.minWidth)||0,r=parseInt(this.style.minHeight)||0,h=parseInt(this.style.maxWidth)||1/0,u=parseInt(this.style.maxHeight)||1/0;if(!i){var f,g,x,m;i=this.resizeHandle=s('<div class="djs-direct-editing-resize-handle"></div>');var v=function(i){c(i),p(i);var n=d(l(x+i.clientX-f,o),h),s=d(l(m+i.clientY-g,r),u);e.style.width=n+"px",e.style.height=s+"px",t.resizeHandler({width:x,height:m,dx:i.clientX-f,dy:i.clientY-g})},y=function(t){c(t),p(t),a.unbind(document,"mousemove",v,!1),a.unbind(document,"mouseup",y,!1)};a.bind(i,"mousedown",(function(t){c(t),p(t),f=t.clientX,g=t.clientY;var i=e.getBoundingClientRect();x=i.width,m=i.height,a.bind(document,"mousemove",v),a.bind(document,"mouseup",y)}))}n(i.style,{position:"absolute",bottom:"0px",right:"0px",cursor:"nwse-resize",width:"0",height:"0",borderTop:(parseInt(this.style.fontSize)/4||3)+"px solid transparent",borderRight:(parseInt(this.style.fontSize)/4||3)+"px solid #ccc",borderBottom:(parseInt(this.style.fontSize)/4||3)+"px solid #ccc",borderLeft:(parseInt(this.style.fontSize)/4||3)+"px solid transparent"}),e.appendChild(i)},u.prototype.destroy=function(){var t=this.parent,e=this.content,i=this.resizeHandle;e.innerText="",t.removeAttribute("style"),e.removeAttribute("style"),a.unbind(e,"keydown",this.keyHandler),a.unbind(e,"mousedown",p),a.unbind(e,"input",this.autoResize),a.unbind(e,"paste",this.handlePaste),i&&(i.removeAttribute("style"),h(i)),h(t)},u.prototype.getValue=function(){return this.content.innerText.trim()},u.prototype.getSelection=function(){return window.getSelection().getRangeAt(0)},u.prototype.setSelection=function(t,e){var i=document.createRange();null===t?i.selectNodeContents(this.content):(i.setStart(t,e),i.setEnd(t,e));var n=window.getSelection();n.removeAllRanges(),n.addRange(i)},f.$inject=["eventBus","canvas"],f.prototype.registerProvider=function(t){this._providers.push(t)},f.prototype.isActive=function(t){return!(!this._active||t&&this._active.element!==t)},f.prototype.cancel=function(){this._active&&(this._fire("cancel"),this.close())},f.prototype._fire=function(t,e){this._eventBus.fire("directEditing."+t,e||{active:this._active})},f.prototype.close=function(){this._textbox.destroy(),this._fire("deactivate"),this._active=null,this.resizable=void 0},f.prototype.complete=function(){var t=this._active;if(t){var e,i=t.context.bounds,n=this.$textbox.getBoundingClientRect(),o=this.getValue();o===t.context.text&&n.height===i.height&&n.width===i.width||(e=this._textbox.container.getBoundingClientRect(),t.provider.update(t.element,o,t.context.text,{x:n.left-e.left,y:n.top-e.top,width:n.width,height:n.height})),this._fire("complete"),this.close()}},f.prototype.getValue=function(){return this._textbox.getValue()},f.prototype._handleKey=function(t){t.stopPropagation();var e=t.keyCode||t.charCode;return 27===e?(t.preventDefault(),this.cancel()):13!==e||t.shiftKey?void 0:(t.preventDefault(),this.complete())},f.prototype._handleResize=function(t){this._fire("resize",t)},f.prototype.activate=function(t){var e;this.isActive()&&this.cancel();var i=o(this._providers,(function(i){return(e=i.activate(t))?i:null}));return e&&(this.$textbox=this._textbox.create(e.bounds,e.style,e.text,e.options),this._active={element:t,context:e,provider:i},e.options&&e.options.resizable&&(this.resizable=!0),this._fire("activate")),!!e};const g={__depends__:[t],__init__:["directEditing"],directEditing:["type",f]};export{g as D};
